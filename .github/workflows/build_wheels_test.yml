name: Build Flash-Attention 3 Wheels (Test build)

on:
  workflow_dispatch:

jobs:
  build-win-wheels:
    runs-on: "cirun-azure-windows-runner--${{ github.run_id }}"
    timeout-minutes: 1080
    strategy:
      matrix:
        cuda: ["13.0"]
        cuda_full: ["13.0.2"]
        torch: ["2.9.1"]

    steps:
      - name: Enable Windows long-path
        shell: pwsh
        run: |
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
                           -Name "LongPathsEnabled" `
                           -Value 1 -PropertyType DWORD -Force
          git config --global core.longpaths true

      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CUDA ${{ matrix.cuda }}
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: ${{ matrix.cuda_full }}

      - name: Build wheel
        shell: pwsh
        run: |
          scripts/build_wheel_test.ps1 `
            -CudaVersion "${{ matrix.cuda }}" `
            -TorchVersion "${{ matrix.torch }}" `
            -MaxJobs 7
